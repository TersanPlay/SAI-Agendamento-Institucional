{% extends 'base.html' %}
{% load static %}

{% block title %}Relatórios Avançados - EventoSys{% endblock %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Relatórios Avançados</h1>
                <p class="text-gray-600 mt-2">Gere relatórios personalizados com filtros avançados e análise de dados</p>
            </div>

        </div>
    </div>
    
    <!-- Advanced Filter Section -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6 mb-8 shadow-sm">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Filtros Avançados</h2>
            <button id="toggleFilters" class="text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center">
                <i class="fas fa-chevron-up mr-1" id="filterIcon"></i>Recolher Filtros
            </button>
        </div>
        
        <div id="filterContent">
            <form id="reportForm" class="space-y-6">
                <!-- Date Range Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Data Início
                        </label>
                        <input type="date" id="startDate" name="start_date"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               onchange="applyFiltersDebounced()">
                    </div>
                    
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Data Fim
                        </label>
                        <input type="date" id="endDate" name="end_date"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               onchange="applyFiltersDebounced()">
                    </div>
                    
                    <div>
                        <label for="reportType" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de Relatório
                        </label>
                        <select id="reportType" name="report_type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                onchange="applyFiltersDebounced()">
                            <option value="">Selecione o tipo...</option>
                            {% for value, label in report_types %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Status do Evento
                        </label>
                        <select id="statusFilter" name="status"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                onchange="applyFiltersDebounced()">
                            <option value="">Todos os Status</option>
                            <option value="planejado">Planejado</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
                
                <!-- Quick Date Presets -->
                <div class="bg-pastel-blue-50 rounded-xl p-4">
                    <p class="text-sm font-medium text-gray-700 mb-3">Períodos Predefinidos:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setDateRange(7); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Últimos 7 dias
                        </button>
                        <button type="button" onclick="setDateRange(30); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Últimos 30 dias
                        </button>
                        <button type="button" onclick="setDateRange(90); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Últimos 3 meses
                        </button>
                        <button type="button" onclick="setThisMonth(); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Este mês
                        </button>
                        <button type="button" onclick="setLastMonth(); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Mês passado
                        </button>
                        <button type="button" onclick="setThisYear(); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Este ano
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Departments Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Departamentos
                        </label>
                        <div class="custom-multiselect" id="departmentMultiselect">
                            <div class="multiselect-trigger" onclick="toggleMultiselect('departmentMultiselect')">
                                <span class="multiselect-selected" id="departmentSelected">Selecionar departamentos...</span>
                                <div class="multiselect-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="multiselect-dropdown" id="departmentDropdown">
                                <div class="multiselect-search">
                                    <input type="text" placeholder="Buscar departamentos..." class="multiselect-search-input" oninput="filterMultiselectOptions('departmentMultiselect', this.value)">
                                </div>
                                <div class="multiselect-options">
                                    {% for department in departments %}
                                    <label class="multiselect-option" data-value="{{ department.id }}" data-text="{{ department.name }}">
                                        <input type="checkbox" name="departments" value="{{ department.id }}" onchange="updateMultiselectSelection('departmentMultiselect'); applyFiltersDebounced();">
                                        <span class="checkmark"></span>
                                        <span class="option-text">{{ department.name }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Event Types Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Tipos de Evento
                        </label>
                        <div class="custom-multiselect" id="eventTypeMultiselect">
                            <div class="multiselect-trigger" onclick="toggleMultiselect('eventTypeMultiselect')">
                                <span class="multiselect-selected" id="eventTypeSelected">Selecionar tipos...</span>
                                <div class="multiselect-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="multiselect-dropdown" id="eventTypeDropdown">
                                <div class="multiselect-search">
                                    <input type="text" placeholder="Buscar tipos..." class="multiselect-search-input" oninput="filterMultiselectOptions('eventTypeMultiselect', this.value)">
                                </div>
                                <div class="multiselect-options">
                                    {% for event_type in event_types %}
                                    <label class="multiselect-option" data-value="{{ event_type.id }}" data-text="{{ event_type.name }}">
                                        <input type="checkbox" name="event_types" value="{{ event_type.id }}" onchange="updateMultiselectSelection('eventTypeMultiselect'); applyFiltersDebounced();">
                                        <span class="checkmark"></span>
                                        <span class="option-text">{{ event_type.name }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Locations Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Localizações
                        </label>
                        <div class="custom-multiselect" id="locationMultiselect">
                            <div class="multiselect-trigger" onclick="toggleMultiselect('locationMultiselect')">
                                <span class="multiselect-selected" id="locationSelected">Selecionar localizações...</span>
                                <div class="multiselect-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="multiselect-dropdown" id="locationDropdown">
                                <div class="multiselect-search">
                                    <input type="text" placeholder="Buscar localizações..." class="multiselect-search-input" oninput="filterMultiselectOptions('locationMultiselect', this.value)">
                                </div>
                                <div class="multiselect-options" id="locationOptions">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Search Filter -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="searchFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Pesquisa por Título ou Descrição
                        </label>
                        <div class="relative">
                            <input type="text" id="searchFilter" name="search"
                                   class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Digite para pesquisar eventos..."
                                   oninput="applyFiltersDebounced()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <div class="loading-spinner hidden" id="searchLoading">
                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="responsibleSearchFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Pesquisa por Responsável
                        </label>
                        <div class="relative">
                            <input type="text" id="responsibleSearchFilter" name="responsible_search"
                                   class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Digite o nome do responsável..."
                                   oninput="applyFiltersDebounced()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <div class="loading-spinner hidden" id="responsibleLoading">
                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 pt-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <div class="loading-indicator hidden" id="globalLoading">
                            <i class="fas fa-spinner fa-spin mr-2 text-primary-600"></i>
                            <span>Atualizando resultados...</span>
                        </div>
                        <div class="success-indicator hidden" id="globalSuccess">
                            <i class="fas fa-check-circle mr-2 text-green-600"></i>
                            <span>Filtros aplicados automaticamente</span>
                        </div>
                    </div>
                    <button type="button" id="resetFiltersBtn"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition-colors font-medium flex items-center ml-auto">
                        <i class="fas fa-undo mr-2"></i>Limpar Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Dashboard Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total de Eventos</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="totalEvents">0</p>
                </div>
                <div class="w-12 h-12 bg-pastel-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-pastel-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-gray-600">Comparado ao mês anterior:</span>
                <span class="ml-2 text-green-600 font-medium flex items-center" id="totalEventsChange">
                    <i class="fas fa-arrow-up mr-1"></i>0%
                </span>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Eventos Concluídos</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="completedEvents">0</p>
                </div>
                <div class="w-12 h-12 bg-pastel-green-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-check-circle text-pastel-green-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-pastel-green-500 h-2 rounded-full" style="width: 0%" id="completionRate"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Taxa de conclusão: <span id="completionRateText">0%</span></p>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Departamentos Ativos</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="activeDepartments">0</p>
                </div>
                <div class="w-12 h-12 bg-pastel-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-building text-pastel-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-gray-600">Média por departamento:</span>
                <span class="ml-2 text-gray-900 font-medium" id="avgEventsPerDepartment">0 eventos</span>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Tipos de Eventos</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="eventTypesCount">0</p>
                </div>
                <div class="w-12 h-12 bg-pastel-amber-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-tags text-pastel-amber-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-gray-600">Mais comum:</span>
                <span class="ml-2 text-gray-900 font-medium truncate" id="mostCommonEventType">-</span>
            </div>
        </div>
    </div>
    
    <!-- Data Visualization -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Events by Department Chart -->
        <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Eventos por Departamento</h3>
                <div class="flex gap-2">
                    <button class="text-gray-500 hover:text-gray-700" onclick="toggleChartView('eventsByDepartmentChart')">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="h-64 flex items-center justify-center" id="eventsByDepartmentChart">
                <div class="text-center text-gray-500">
                    <i class="fas fa-chart-bar text-3xl mb-2"></i>
                    <p>Aplicar filtros para visualizar dados</p>
                </div>
            </div>
        </div>
        
        <!-- Trend Chart -->
        <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Tendência de Eventos</h3>
                <div class="flex gap-2">
                    <button class="text-gray-500 hover:text-gray-700" onclick="loadTrendData()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="h-64 flex items-center justify-center" id="trendChart">
                <div class="text-center text-gray-500">
                    <i class="fas fa-chart-line text-3xl mb-2"></i>
                    <p>Carregando tendência...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Events Table -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Eventos Filtrados</h3>
            <div class="flex flex-wrap gap-2">
                <button id="exportPdfBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors font-medium flex items-center shadow-sm">
                    <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
                </button>
                <button id="exportExcelBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors font-medium flex items-center shadow-sm">
                    <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                </button>
                <div class="relative">
                    <input type="text" id="tableSearch" placeholder="Pesquisar na tabela..."
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
                <select id="itemsPerPage" class="py-2 pl-3 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <option value="10">10 por página</option>
                    <option value="25" selected>25 por página</option>
                    <option value="50">50 por página</option>
                    <option value="100">100 por página</option>
                </select>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(0)">
                            Evento <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(1)">
                            Tipo <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(2)">
                            Departamento <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(3)">
                            Data <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(4)">
                            Status <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(5)">
                            Responsável <i class="fas fa-sort ml-1"></i>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="eventsTableBody">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-filter text-gray-400 mr-2"></i>
                            Aplique filtros para carregar os eventos
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-6">
            <div class="text-sm text-gray-700">
                Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalResults">0</span> resultados
            </div>
            <div class="flex gap-2">
                <button id="prevPage" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg bg-primary-50 text-primary-700">1</button>
                <button class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">2</button>
                <button class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">3</button>
                <button class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <button id="nextPage" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle filter section
document.getElementById('toggleFilters').addEventListener('click', function() {
    const filterContent = document.getElementById('filterContent');
    const filterIcon = document.getElementById('filterIcon');
    
    if (filterContent.classList.contains('hidden')) {
        filterContent.classList.remove('hidden');
        filterIcon.classList.remove('fa-chevron-down');
        filterIcon.classList.add('fa-chevron-up');
        this.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Recolher Filtros';
    } else {
        filterContent.classList.add('hidden');
        filterIcon.classList.remove('fa-chevron-up');
        filterIcon.classList.add('fa-chevron-down');
        this.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Expandir Filtros';
    }
});

// Date range functions
function setDateRange(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - days);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function setThisMonth() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = today;
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function setLastMonth() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const endDate = new Date(today.getFullYear(), today.getMonth(), 0);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function setThisYear() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), 0, 1);
    const endDate = today;
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

// Loading indicators
function applyFiltersDebounced() {
    showLoadingIndicator();
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
        loadReportData();
    }, 500);
}

function showLoadingIndicator() {
    const globalLoading = document.getElementById('globalLoading');
    const globalSuccess = document.getElementById('globalSuccess');
    
    if (globalLoading) {
        globalLoading.classList.remove('hidden');
    }
    if (globalSuccess) {
        globalSuccess.classList.add('hidden');
    }
}

function hideLoadingIndicator() {
    const globalLoading = document.getElementById('globalLoading');
    const globalSuccess = document.getElementById('globalSuccess');
    
    if (globalLoading) {
        globalLoading.classList.add('hidden');
    }
    if (globalSuccess) {
        globalSuccess.classList.remove('hidden');
        setTimeout(() => {
            globalSuccess.classList.add('hidden');
        }, 2000);
    }
}

function setThisMonth() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = start.toISOString().split('T')[0];
    document.getElementById('endDate').value = end.toISOString().split('T')[0];
}

function setLastMonth() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const end = new Date(now.getFullYear(), now.getMonth(), 0);
    
    document.getElementById('startDate').value = start.toISOString().split('T')[0];
    document.getElementById('endDate').value = end.toISOString().split('T')[0];
}

function setThisYear() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const end = new Date(now.getFullYear(), 11, 31);
    
    document.getElementById('startDate').value = start.toISOString().split('T')[0];
    document.getElementById('endDate').value = end.toISOString().split('T')[0];
}

// Set default dates (last 30 days)
document.addEventListener('DOMContentLoaded', function() {
    setDateRange(30);
    
    // Load initial data
    loadReportData();
    
    // Load locations
    loadLocations();
    
    // Initialize multiselect dropdowns
    initializeMultiselects();
});

// Dynamic filtering with debounce
let filterTimeout;
function applyFiltersDebounced() {
    // Show loading indicator
    showLoadingIndicator();
    
    // Clear existing timeout
    clearTimeout(filterTimeout);
    
    // Set new timeout for 500ms delay
    filterTimeout = setTimeout(() => {
        loadReportData();
    }, 500);
}

// Show loading indicators
function showLoadingIndicator() {
    const globalLoading = document.getElementById('globalLoading');
    const globalSuccess = document.getElementById('globalSuccess');
    
    if (globalLoading) {
        globalLoading.classList.remove('hidden');
    }
    if (globalSuccess) {
        globalSuccess.classList.add('hidden');
    }
}

// Hide loading indicators and show success
function hideLoadingIndicator() {
    const globalLoading = document.getElementById('globalLoading');
    const globalSuccess = document.getElementById('globalSuccess');
    
    if (globalLoading) {
        globalLoading.classList.add('hidden');
    }
    if (globalSuccess) {
        globalSuccess.classList.remove('hidden');
        // Auto-hide success message after 2 seconds
        setTimeout(() => {
            globalSuccess.classList.add('hidden');
        }, 2000);
    }
}

// Reset filters with immediate update
document.getElementById('resetFiltersBtn').addEventListener('click', function() {
    // Reset form
    document.getElementById('reportForm').reset();
    
    // Reset multiselect dropdowns
    resetAllMultiselects();
    
    // Set default dates
    setDateRange(30);
    
    // Reload data immediately
    loadReportData();
});

// Export functions
document.getElementById('exportPdfBtn').addEventListener('click', function() {
    // Get form data
    const formData = new FormData(document.getElementById('reportForm'));
    formData.append('format', 'pdf');
    formData.append('report_type', 'events_by_period');
    
    // Submit form to generate report
    submitReportForm(formData);
});

document.getElementById('exportExcelBtn').addEventListener('click', function() {
    // Get form data
    const formData = new FormData(document.getElementById('reportForm'));
    formData.append('format', 'excel');
    formData.append('report_type', 'events_by_period');
    
    // Submit form to generate report
    submitReportForm(formData);
});

// Submit report form for export
function submitReportForm(formData) {
    // Create a temporary form to submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "reports:export" %}';
    
    // Add CSRF token
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfToken);
    
    // Add form data
    for (const [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    // Submit form
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// Load report data from API with improved form handling
function loadReportData() {
    // Show loading state
    const tableBody = document.getElementById('eventsTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                <div class="flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin mr-2 text-primary-600"></i>
                    Carregando dados...
                </div>
            </td>
        </tr>
    `;
    
    // Get form data from multiselects and other inputs
    const params = new URLSearchParams();
    
    // Get date filters
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const reportType = document.getElementById('reportType').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchFilter').value;
    const responsibleSearch = document.getElementById('responsibleSearchFilter').value;
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (reportType) params.append('report_type', reportType);
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    if (responsibleSearch) params.append('responsible_search', responsibleSearch);
    
    // Get multiselect values
    const departmentValues = getMultiselectValues('departmentMultiselect');
    const eventTypeValues = getMultiselectValues('eventTypeMultiselect');
    const locationValues = getMultiselectValues('locationMultiselect');
    
    departmentValues.forEach(value => params.append('departments', value));
    eventTypeValues.forEach(value => params.append('event_types', value));
    locationValues.forEach(value => params.append('locations', value));
    
    // Fetch data from API
    fetch('{% url "reports:api_data" %}?' + params.toString())
        .then(response => response.json())
        .then(data => {
            // Hide loading indicators
            hideLoadingIndicator();
            
            // Update stats
            document.getElementById('totalEvents').textContent = data.total_events;
            document.getElementById('completedEvents').textContent = data.completed_events;
            document.getElementById('activeDepartments').textContent = data.departments_count;
            document.getElementById('eventTypesCount').textContent = data.event_types_count;
            
            // Update completion rate
            const completionRate = data.total_events > 0 ? 
                Math.round((data.completed_events / data.total_events) * 100) : 0;
            document.getElementById('completionRate').style.width = completionRate + '%';
            document.getElementById('completionRateText').textContent = completionRate + '%';
            
            // Update additional stats
            const avgEventsPerDepartment = data.departments_count > 0 ? 
                Math.round(data.total_events / data.departments_count) : 0;
            document.getElementById('avgEventsPerDepartment').textContent = avgEventsPerDepartment + ' eventos';
            
            // Update most common event type
            if (data.events_by_type && data.events_by_type.length > 0) {
                document.getElementById('mostCommonEventType').textContent = data.events_by_type[0].event_type__name;
            } else {
                document.getElementById('mostCommonEventType').textContent = '-';
            }
            
            // Update comparison data
            if (data.comparison) {
                const totalChangeElement = document.getElementById('totalEventsChange');
                const totalChangePercent = data.comparison.total_change_percent;
                
                if (totalChangePercent > 0) {
                    totalChangeElement.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>${totalChangePercent}%`;
                    totalChangeElement.className = 'ml-2 text-green-600 font-medium flex items-center';
                } else if (totalChangePercent < 0) {
                    totalChangeElement.innerHTML = `<i class="fas fa-arrow-down mr-1"></i>${Math.abs(totalChangePercent)}%`;
                    totalChangeElement.className = 'ml-2 text-red-600 font-medium flex items-center';
                } else {
                    totalChangeElement.innerHTML = `<i class="fas fa-equals mr-1"></i>${totalChangePercent}%`;
                    totalChangeElement.className = 'ml-2 text-gray-600 font-medium flex items-center';
                }
            }
            
            // Update table
            if (data.events && data.events.length > 0) {
                let tableRows = '';
                data.events.forEach(event => {
                    tableRows += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${event.name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${event.event_type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${event.department}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${event.start_datetime}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                    event.status === 'Concluído' ? 'bg-green-100 text-green-800' :
                                    event.status === 'Em Andamento' ? 'bg-yellow-100 text-yellow-800' :
                                    event.status === 'Planejado' ? 'bg-blue-100 text-blue-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${event.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${event.responsible_person}
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = tableRows;
                
                // Update pagination
                document.getElementById('showingFrom').textContent = '1';
                document.getElementById('showingTo').textContent = Math.min(25, data.total_events);
                document.getElementById('totalResults').textContent = data.total_events;
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                            Nenhum evento encontrado com os filtros aplicados
                        </td>
                    </tr>
                `;
                
                // Update pagination
                document.getElementById('showingFrom').textContent = '0';
                document.getElementById('showingTo').textContent = '0';
                document.getElementById('totalResults').textContent = '0';
            }
            
            // Update charts
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading report data:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Erro ao carregar dados. Tente novamente.
                    </td>
                </tr>
            `;
        });
}

// Update charts with data
function updateCharts(data) {
    // Events by Department Chart
    if (data.events_by_department && data.events_by_department.length > 0) {
        let chartHtml = `
            <div class="w-full h-full">
                <div class="flex flex-col h-full">
                    <div class="flex-1 overflow-hidden">
        `;
        
        // Find max count for scaling
        const maxCount = Math.max(...data.events_by_department.map(item => item.count));
        
        // Determine layout based on number of items
        const itemCount = data.events_by_department.length;
        const useHorizontalLayout = itemCount > 4;
        
        if (useHorizontalLayout) {
            // Horizontal bar chart for many departments
            chartHtml += `
                <div class="space-y-3 max-h-48 overflow-y-auto">
            `;
            
            data.events_by_department.forEach((item, index) => {
                const widthPercentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
                const colors = ['bg-pastel-blue-500', 'bg-pastel-green-500', 'bg-pastel-purple-500', 'bg-pastel-amber-500', 'bg-pastel-rose-500'];
                const color = colors[index % colors.length];
                
                chartHtml += `
                    <div class="flex items-center">
                        <div class="w-24 text-xs text-gray-600 truncate pr-2" title="${item.department__name}">
                            ${item.department__name}
                        </div>
                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                            <div class="${color} h-6 rounded-full flex items-center justify-end pr-2 transition-all duration-300" style="width: ${widthPercentage}%">
                                <span class="text-xs font-medium text-white">${item.count}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            chartHtml += `
                </div>
            `;
        } else {
            // Vertical bar chart for fewer departments
            chartHtml += `
                <div class="flex items-end justify-center h-40 gap-4">
            `;
            
            data.events_by_department.forEach((item, index) => {
                const heightPercentage = maxCount > 0 ? (item.count / maxCount) * 90 : 0;
                const colors = ['bg-pastel-blue-500', 'bg-pastel-green-500', 'bg-pastel-purple-500', 'bg-pastel-amber-500', 'bg-pastel-rose-500'];
                const hoverColors = ['hover:bg-pastel-blue-600', 'hover:bg-pastel-green-600', 'hover:bg-pastel-purple-600', 'hover:bg-pastel-amber-600', 'hover:bg-pastel-rose-600'];
                const color = colors[index % colors.length];
                const hoverColor = hoverColors[index % hoverColors.length];
                
                chartHtml += `
                    <div class="flex flex-col items-center group">
                        <div class="relative">
                            <div class="w-12 ${color} ${hoverColor} rounded-t transition-all duration-300 flex items-end justify-center pb-1" style="height: ${heightPercentage}%">
                                <span class="text-xs font-bold text-white">${item.count}</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mt-2 text-center max-w-20">
                            <div class="truncate" title="${item.department__name}">
                                ${item.department__name}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            chartHtml += `
                </div>
            `;
        }
        
        chartHtml += `
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-sm text-gray-600 font-medium">
                            Eventos por departamento
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Total: ${data.events_by_department.reduce((sum, item) => sum + item.count, 0)} eventos
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('eventsByDepartmentChart').innerHTML = chartHtml;
    } else {
        document.getElementById('eventsByDepartmentChart').innerHTML = `
            <div class="text-center text-gray-500 h-full flex items-center justify-center">
                <div>
                    <i class="fas fa-chart-bar text-3xl mb-2"></i>
                    <p>Sem dados suficientes para exibir</p>
                    <p class="text-xs mt-1">Aplique filtros para visualizar dados</p>
                </div>
            </div>
        `;
    }
}

// Load trend data
function loadTrendData() {
    fetch('{% url "reports:api_trend" %}')
        .then(response => response.json())
        .then(data => {
            // Create a simple line chart using CSS and HTML
            let chartHtml = `
                <div class="w-full h-full flex flex-col">
                    <div class="flex-1 relative">
                        <svg viewBox="0 0 400 200" class="w-full h-full">
            `;
            
            // Calculate points for the line chart
            const maxCount = Math.max(...data.event_counts);
            const points = [];
            
            data.months.forEach((month, index) => {
                const x = (index / (data.months.length - 1)) * 380 + 10;
                const y = 190 - (data.event_counts[index] / maxCount) * 180;
                points.push(`${x},${y}`);
            });
            
            // Draw the line
            chartHtml += `
                            <polyline 
                                points="${points.join(' ')}" 
                                fill="none" 
                                stroke="#3b82f6" 
                                stroke-width="2"
                                class="drop-shadow-sm">
                            </polyline>
            `;
            
            // Draw points
            points.forEach((point, index) => {
                const [x, y] = point.split(',');
                chartHtml += `
                    <circle cx="${x}" cy="${y}" r="4" fill="#3b82f6" class="hover:r-6 transition-all"></circle>
                    <text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#4b5563">${data.event_counts[index]}</text>
                `;
            });
            
            // Draw x-axis labels
            data.months.forEach((month, index) => {
                const x = (index / (data.months.length - 1)) * 380 + 10;
                chartHtml += `
                    <text x="${x}" y="210" text-anchor="middle" font-size="10" fill="#6b7280">${month.substring(0, 3)}</text>
                `;
            });
            
            chartHtml += `
                        </svg>
                    </div>
                    <div class="text-center text-sm text-gray-600 mt-2">
                        Eventos nos últimos 12 meses
                    </div>
                </div>
            `;
            
            document.getElementById('trendChart').innerHTML = chartHtml;
        })
        .catch(error => {
            console.error('Error loading trend data:', error);
            document.getElementById('trendChart').innerHTML = `
                <div class="text-center text-gray-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                    <p>Erro ao carregar tendência</p>
                </div>
            `;
        });
}

// Toggle chart view (expand/collapse)
function toggleChartView(chartId) {
    const chart = document.getElementById(chartId);
    const isExpanded = chart.classList.contains('expanded-chart');
    
    if (isExpanded) {
        chart.classList.remove('expanded-chart');
        chart.style.height = '16rem';
    } else {
        chart.classList.add('expanded-chart');
        chart.style.height = '32rem';
    }
}

// Load locations dynamically for multiselect
function loadLocations() {
    fetch('{% url "reports:api_locations" %}')
        .then(response => response.json())
        .then(data => {
            const optionsContainer = document.getElementById('locationOptions');
            optionsContainer.innerHTML = '';
            
            data.locations.forEach(location => {
                const label = document.createElement('label');
                label.className = 'multiselect-option';
                label.setAttribute('data-value', location.id);
                label.setAttribute('data-text', location.name);
                
                label.innerHTML = `
                    <input type="checkbox" name="locations" value="${location.id}" onchange="updateMultiselectSelection('locationMultiselect'); applyFiltersDebounced();">
                    <span class="checkmark"></span>
                    <span class="option-text">${location.name}</span>
                `;
                
                optionsContainer.appendChild(label);
            });
        })
        .catch(error => {
            console.error('Error loading locations:', error);
        });
}

// Custom Multiselect Functions
function initializeMultiselects() {
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.custom-multiselect')) {
            document.querySelectorAll('.multiselect-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
            document.querySelectorAll('.multiselect-arrow i').forEach(arrow => {
                arrow.className = 'fas fa-chevron-down';
            });
        }
    });
}

function toggleMultiselect(multiselectId) {
    const multiselect = document.getElementById(multiselectId);
    const dropdown = multiselect.querySelector('.multiselect-dropdown');
    const arrow = multiselect.querySelector('.multiselect-arrow i');
    
    // Close other dropdowns
    document.querySelectorAll('.multiselect-dropdown').forEach(dd => {
        if (dd !== dropdown) {
            dd.style.display = 'none';
        }
    });
    document.querySelectorAll('.multiselect-arrow i').forEach(arr => {
        if (arr !== arrow) {
            arr.className = 'fas fa-chevron-down';
        }
    });
    
    // Toggle current dropdown
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
        arrow.className = 'fas fa-chevron-down';
    } else {
        dropdown.style.display = 'block';
        arrow.className = 'fas fa-chevron-up';
    }
}

function updateMultiselectSelection(multiselectId) {
    const multiselect = document.getElementById(multiselectId);
    const selectedSpan = multiselect.querySelector('.multiselect-selected');
    const checkboxes = multiselect.querySelectorAll('input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        const defaultTexts = {
            'departmentMultiselect': 'Selecionar departamentos...',
            'eventTypeMultiselect': 'Selecionar tipos...',
            'locationMultiselect': 'Selecionar localizações...'
        };
        selectedSpan.textContent = defaultTexts[multiselectId] || 'Selecionar...';
        selectedSpan.className = 'multiselect-selected';
    } else if (checkboxes.length === 1) {
        selectedSpan.textContent = checkboxes[0].closest('.multiselect-option').getAttribute('data-text');
        selectedSpan.className = 'multiselect-selected selected';
    } else {
        selectedSpan.textContent = `${checkboxes.length} itens selecionados`;
        selectedSpan.className = 'multiselect-selected selected';
    }
}

function getMultiselectValues(multiselectId) {
    const multiselect = document.getElementById(multiselectId);
    const checkboxes = multiselect.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function filterMultiselectOptions(multiselectId, searchText) {
    const multiselect = document.getElementById(multiselectId);
    const options = multiselect.querySelectorAll('.multiselect-option');
    
    options.forEach(option => {
        const text = option.getAttribute('data-text').toLowerCase();
        if (text.includes(searchText.toLowerCase())) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
}

function resetAllMultiselects() {
    document.querySelectorAll('.custom-multiselect').forEach(multiselect => {
        const checkboxes = multiselect.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        const multiselectId = multiselect.id;
        updateMultiselectSelection(multiselectId);
    });
}

// Sort table by column
function sortTable(columnIndex) {
    // In a real implementation, this would re-fetch data with sorting parameters
    console.log('Sorting by column:', columnIndex);
}

// Table search functionality
let tableSearchTimeout;
function initializeTableSearch() {
    const searchInput = document.getElementById('tableSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(tableSearchTimeout);
            tableSearchTimeout = setTimeout(() => {
                filterTableRows(this.value);
            }, 300);
        });
    }
    
    // Items per page functionality
    const itemsPerPageSelect = document.getElementById('itemsPerPage');
    if (itemsPerPageSelect) {
        itemsPerPageSelect.addEventListener('change', function() {
            updateTablePagination(parseInt(this.value));
        });
    }
}

function filterTableRows(searchTerm) {
    const tableBody = document.getElementById('eventsTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        if (cells.length > 1) { // Skip empty state rows
            for (let j = 0; j < cells.length; j++) {
                const cellText = cells[j].textContent.toLowerCase();
                if (cellText.includes(searchTerm.toLowerCase())) {
                    found = true;
                    break;
                }
            }
        }
        
        if (found || searchTerm === '') {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Update pagination info
    updatePaginationInfo(visibleCount);
}

function updateTablePagination(itemsPerPage) {
    // This would normally re-fetch data with new page size
    // For now, we'll just update the display
    console.log('Items per page changed to:', itemsPerPage);
    applyFiltersDebounced();
}

function updatePaginationInfo(visibleCount) {
    document.getElementById('showingFrom').textContent = visibleCount > 0 ? '1' : '0';
    document.getElementById('showingTo').textContent = visibleCount.toString();
    document.getElementById('totalResults').textContent = visibleCount.toString();
}

// Export functionality
function initializeExportButtons() {
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', function() {
            exportReport('pdf');
        });
    }
    
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
            exportReport('excel');
        });
    }
}

function exportReport(format) {
    // Show loading state
    const button = format === 'pdf' ? document.getElementById('exportPdfBtn') : document.getElementById('exportExcelBtn');
    const originalText = button.innerHTML;
    button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Gerando ${format.toUpperCase()}...`;
    button.disabled = true;
    
    // Collect all current filter data
    const formData = new FormData();
    
    // Get filter values
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const reportType = document.getElementById('reportType').value || 'events_by_period';
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchFilter').value;
    const responsibleSearch = document.getElementById('responsibleSearchFilter').value;
    
    // Add basic filters
    if (startDate) formData.append('start_date', startDate);
    if (endDate) formData.append('end_date', endDate);
    formData.append('report_type', reportType);
    if (status) formData.append('status', status);
    if (search) formData.append('search', search);
    if (responsibleSearch) formData.append('responsible_search', responsibleSearch);
    formData.append('format', format);
    
    // Add multiselect values
    const departmentValues = getMultiselectValues('departmentMultiselect');
    const eventTypeValues = getMultiselectValues('eventTypeMultiselect');
    const locationValues = getMultiselectValues('locationMultiselect');
    
    departmentValues.forEach(value => formData.append('departments', value));
    eventTypeValues.forEach(value => formData.append('event_types', value));
    locationValues.forEach(value => formData.append('locations', value));
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Submit the export request
    fetch('{% url "reports:export" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Erro na resposta do servidor');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `relatorio_${reportType}_${new Date().getTime()}.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        showExportSuccess(format);
    })
    .catch(error => {
        console.error('Export error:', error);
        showExportError(format, error.message);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showExportSuccess(format) {
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    successDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>Relatório ${format.toUpperCase()} gerado com sucesso!</span>
        </div>
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        document.body.removeChild(successDiv);
    }, 3000);
}

function showExportError(format, message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    errorDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>Erro ao gerar ${format.toUpperCase()}: ${message}</span>
        </div>
    `;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        document.body.removeChild(errorDiv);
    }, 5000);
}

// Initialize with sample data
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    setDateRange(30);
    
    // Initialize multiselects
    initializeMultiselects();
    
    // Initialize table search and pagination
    initializeTableSearch();
    
    // Initialize export buttons
    initializeExportButtons();
    
    // Load locations
    loadLocations();
    
    // Load trend data
    loadTrendData();
    
    // Load initial report data
    loadReportData();
});

</script>

<style>
/* Custom Multiselect Styles */
.custom-multiselect {
    position: relative;
    width: 100%;
}

.multiselect-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
}

.multiselect-trigger:hover {
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
}

.multiselect-trigger:focus-within {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.multiselect-selected {
    color: #6b7280;
    font-size: 14px;
    flex: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.multiselect-selected.selected {
    color: #1f2937;
    font-weight: 500;
}

.multiselect-arrow {
    margin-left: 8px;
    transition: transform 0.2s ease;
}

.multiselect-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    z-index: 1000;
    display: none;
    max-height: 250px;
    overflow: hidden;
}

.multiselect-search {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
}

.multiselect-search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
}

.multiselect-search-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
}

.multiselect-options {
    max-height: 180px;
    overflow-y: auto;
    padding: 4px;
}

.multiselect-option {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
    margin: 2px 0;
    transition: background-color 0.15s ease;
    position: relative;
    user-select: none;
}

.multiselect-option:hover {
    background-color: #f3f4f6;
}

.multiselect-option input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.checkmark {
    position: relative;
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    margin-right: 12px;
    background: white;
    transition: all 0.2s ease;
}

.multiselect-option input[type="checkbox"]:checked ~ .checkmark {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.multiselect-option input[type="checkbox"]:checked ~ .checkmark:after {
    content: '';
    position: absolute;
    display: block;
    left: 5px;
    top: 2px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.option-text {
    font-size: 14px;
    color: #374151;
    flex: 1;
}

/* Loading Indicators */
.loading-indicator {
    display: flex;
    align-items: center;
    padding: 8px 0;
    color: #6b7280;
    font-size: 14px;
}

.success-indicator {
    display: flex;
    align-items: center;
    padding: 8px 0;
    color: #059669;
    font-size: 14px;
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Improved transitions */
.transition-all {
    transition: all 0.2s ease;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .multiselect-dropdown {
        max-height: 200px;
    }
    
    .multiselect-options {
        max-height: 150px;
    }
    
    .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

/* Hide default scrollbar styling */
.multiselect-options::-webkit-scrollbar {
    width: 6px;
}

.multiselect-options::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.multiselect-options::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.multiselect-options::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Chart transitions */
.expanded-chart {
    transition: height 0.3s ease;
}

/* Enhanced chart styles */
.bg-pastel-blue-500 {
    background-color: #3b82f6;
}

.bg-pastel-green-500 {
    background-color: #10b981;
}

.bg-pastel-purple-500 {
    background-color: #8b5cf6;
}

.bg-pastel-amber-500 {
    background-color: #f59e0b;
}

.bg-pastel-rose-500 {
    background-color: #f43f5e;
}

.hover\:bg-pastel-blue-600:hover {
    background-color: #2563eb;
}

.hover\:bg-pastel-green-600:hover {
    background-color: #059669;
}

.hover\:bg-pastel-purple-600:hover {
    background-color: #7c3aed;
}

.hover\:bg-pastel-amber-600:hover {
    background-color: #d97706;
}

.hover\:bg-pastel-rose-600:hover {
    background-color: #e11d48;
}

/* Export notification styles */
.notification {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Table search highlight */
.search-highlight {
    background-color: #fef3c7;
    font-weight: 600;
}
</style>
{% endblock %}