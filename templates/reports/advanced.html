{% extends 'base.html' %}
{% load static %}

{% block title %}Relatórios Avançados - EventoSys{% endblock %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Relatórios Avançados</h1>
                <p class="text-gray-600 mt-2">Gere relatórios personalizados com filtros avançados e análise de dados</p>
            </div>

        </div>
    </div>
    
    <!-- Advanced Filter Section -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6 mb-8 shadow-sm">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Filtros Avançados</h2>
            <button id="toggleFilters" class="text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center">
                <i class="fas fa-chevron-up mr-1" id="filterIcon"></i>Recolher Filtros
            </button>
        </div>
        
        <div id="filterContent">
            <form id="reportForm" class="space-y-6">
                <!-- Date Range Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Data Início
                        </label>
                        <input type="date" id="startDate" name="start_date"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               onchange="applyFiltersDebounced()">
                    </div>
                    
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Data Fim
                        </label>
                        <input type="date" id="endDate" name="end_date"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               onchange="applyFiltersDebounced()">
                    </div>
                    
                    <div>
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Status do Evento
                        </label>
                        <select id="statusFilter" name="status"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                onchange="applyFiltersDebounced()">
                            <option value="">Todos os Status</option>
                            <option value="planejado">Planejado</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
                
                <!-- Advanced Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Departments Filter -->
                    <div>
                        <label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Departamentos
                        </label>
                        <select id="departmentFilter" name="departments"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                onchange="applyFiltersDebounced()">
                            <option value="">Todos os Departamentos</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Event Types Filter -->
                    <div>
                        <label for="eventTypeFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipos de Evento
                        </label>
                        <select id="eventTypeFilter" name="event_types"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                onchange="applyFiltersDebounced()">
                            <option value="">Todos os Tipos</option>
                            {% for event_type in event_types %}
                            <option value="{{ event_type.id }}">{{ event_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Locations Filter -->
                    <div>
                        <label for="locationFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Localizações
                        </label>
                        <select id="locationFilter" name="locations"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                onchange="applyFiltersDebounced()">
                            <option value="">Todas as Localizações</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <!-- Search Filter -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="searchFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Pesquisa por Título ou Descrição
                        </label>
                        <div class="relative">
                            <input type="text" id="searchFilter" name="search"
                                   class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Digite para pesquisar eventos..."
                                   oninput="applyFiltersDebounced()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <div class="loading-spinner hidden" id="searchLoading">
                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="responsibleSearchFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            Pesquisa por Responsável
                        </label>
                        <div class="relative">
                            <input type="text" id="responsibleSearchFilter" name="responsible_search"
                                   class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Digite o nome do responsável..."
                                   oninput="applyFiltersDebounced()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <div class="loading-spinner hidden" id="responsibleLoading">
                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Date Presets -->
                <div class="bg-pastel-blue-50 rounded-xl p-4">
                    <p class="text-sm font-medium text-gray-700 mb-3">Períodos Predefinidos:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setDateRange(7); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Últimos 7 dias
                        </button>
                        <button type="button" onclick="setDateRange(30); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Últimos 30 dias
                        </button>
                        <button type="button" onclick="setDateRange(90); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Últimos 3 meses
                        </button>
                        <button type="button" onclick="setThisMonth(); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Este mês
                        </button>
                        <button type="button" onclick="setLastMonth(); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Mês passado
                        </button>
                        <button type="button" onclick="setThisYear(); applyFiltersDebounced();" 
                                class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors shadow-sm">
                            Este ano
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 pt-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <div class="loading-indicator hidden" id="globalLoading">
                            <i class="fas fa-spinner fa-spin mr-2 text-primary-600"></i>
                            <span>Atualizando resultados...</span>
                        </div>
                        <div class="success-indicator hidden" id="globalSuccess">
                            <i class="fas fa-check-circle mr-2 text-green-600"></i>
                            <span>Filtros aplicados automaticamente</span>
                        </div>
                    </div>
                    <button type="button" id="resetFiltersBtn"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition-colors font-medium flex items-center ml-auto">
                        <i class="fas fa-undo mr-2"></i>Limpar Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Data Visualization -->
    <div class="grid grid-cols-1 gap-8 mb-8">

    </div>
    
    <!-- Events Table -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Eventos Filtrados</h3>
            <div class="flex flex-wrap gap-2">
                <button id="exportPdfBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors font-medium flex items-center shadow-sm">
                    <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
                </button>
                <button id="exportExcelBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors font-medium flex items-center shadow-sm">
                    <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                </button>
                <div class="relative">
                    <input type="text" id="tableSearch" placeholder="Pesquisar na tabela..."
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(0)">
                            Evento <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(1)">
                            Tipo <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(2)">
                            Departamento <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(3)">
                            Data <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(4)">
                            Status <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable(5)">
                            Responsável <i class="fas fa-sort ml-1"></i>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="eventsTableBody">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-filter text-gray-400 mr-2"></i>
                            Aplique filtros para carregar os eventos
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-6">
            <div class="text-sm text-gray-700">
                Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalResults">0</span> resultados
            </div>
            <div class="flex gap-2 pagination-container">
                <button id="prevPage" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <!-- Page buttons will be dynamically generated here -->
                <button id="nextPage" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Consolidated DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    // Initialize pagination state first
    window.currentPagination = {
        page: 1,
        itemsPerPage: 15
    };
    
    // Initialize multiselect dropdowns
    
    // Initialize table search and pagination
    initializeTableSearch();
    
    // Initialize export buttons
    initializeExportButtons();
    
    // Load locations
    loadLocations();
    
    // Set default dates
    setDateRange(30);
    
    // Load initial data
    loadReportData();
    
    // Initialize toggle filter button
    const toggleFiltersBtn = document.getElementById('toggleFilters');
    if (toggleFiltersBtn) {
        toggleFiltersBtn.addEventListener('click', function() {
            const filterContent = document.getElementById('filterContent');
            const filterIcon = document.getElementById('filterIcon');
            
            if (filterContent.classList.contains('hidden')) {
                filterContent.classList.remove('hidden');
                filterIcon.classList.remove('fa-chevron-down');
                filterIcon.classList.add('fa-chevron-up');
                this.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Recolher Filtros';
            } else {
                filterContent.classList.add('hidden');
                filterIcon.classList.remove('fa-chevron-up');
                filterIcon.classList.add('fa-chevron-down');
                this.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Expandir Filtros';
            }
        });
    }
});

// Date range functions
function setDateRange(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - days);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function setThisMonth() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = today;
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function setLastMonth() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const endDate = new Date(today.getFullYear(), today.getMonth(), 0);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function setThisYear() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), 0, 1);
    const endDate = today;
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

// Loading indicators
function showLoadingIndicator() {
    const globalLoading = document.getElementById('globalLoading');
    const globalSuccess = document.getElementById('globalSuccess');
    
    if (globalLoading) {
        globalLoading.classList.remove('hidden');
    }
    if (globalSuccess) {
        globalSuccess.classList.add('hidden');
    }
}

function hideLoadingIndicator() {
    const globalLoading = document.getElementById('globalLoading');
    const globalSuccess = document.getElementById('globalSuccess');
    
    if (globalLoading) {
        globalLoading.classList.add('hidden');
    }
    if (globalSuccess) {
        globalSuccess.classList.remove('hidden');
        setTimeout(() => {
            globalSuccess.classList.add('hidden');
        }, 2000);
    }
}

// Dynamic filtering with debounce
let filterTimeout;
function applyFiltersDebounced() {
    // Show loading indicator
    showLoadingIndicator();
    
    // Clear existing timeout
    clearTimeout(filterTimeout);
    
    // Set new timeout for 500ms delay
    filterTimeout = setTimeout(() => {
        loadReportData();
    }, 500);
}

// Reset filters with immediate update
document.getElementById('resetFiltersBtn').addEventListener('click', function() {
    // Reset form
    document.getElementById('reportForm').reset();
    
    // Set default dates
    setDateRange(30);
    
    // Reload data immediately
    loadReportData();
});

// Export functions
document.getElementById('exportPdfBtn').addEventListener('click', function() {
    // Get form data
    const formData = new FormData(document.getElementById('reportForm'));
    formData.append('format', 'pdf');
    
    // Submit form to generate report
    submitReportForm(formData);
});

document.getElementById('exportExcelBtn').addEventListener('click', function() {
    // Get form data
    const formData = new FormData(document.getElementById('reportForm'));
    formData.append('format', 'excel');
    
    // Submit form to generate report
    submitReportForm(formData);
});

// Submit report form for export
function submitReportForm(formData) {
    // Create a temporary form to submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "reports:export" %}';
    
    // Add CSRF token
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfToken);
    
    // Add form data
    for (const [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    // Submit form
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// Load report data from API with improved form handling
function loadReportData() {
    // Show loading state
    const tableBody = document.getElementById('eventsTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                <div class="flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin mr-2 text-primary-600"></i>
                    Carregando dados...
                </div>
            </td>
        </tr>
    `;
    
    // Get form data from selects and other inputs
    const params = new URLSearchParams();
    
    // Get date filters
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchFilter').value;
    const responsibleSearch = document.getElementById('responsibleSearchFilter').value;
    const department = document.getElementById('departmentFilter').value;
    const eventType = document.getElementById('eventTypeFilter').value;
    const location = document.getElementById('locationFilter').value;
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    if (responsibleSearch) params.append('responsible_search', responsibleSearch);
    if (department) params.append('departments', department);
    if (eventType) params.append('event_types', eventType);
    if (location) params.append('locations', location);
    
    // Add pagination parameters
    if (window.currentPagination) {
        params.append('page', window.currentPagination.page);
        params.append('page_size', window.currentPagination.itemsPerPage);
    } else {
        // Default pagination with 15 items per page
        params.append('page', 1);
        params.append('page_size', 15);
    }
    
    // Show loading indicator in the pagination info area
    document.getElementById('showingFrom').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    document.getElementById('showingTo').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    document.getElementById('totalResults').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Fetch data from API
    fetch('{% url "reports:api_data" %}?' + params.toString())
        .then(response => response.json())
        .then(data => {
            // Hide loading indicators
            hideLoadingIndicator();
            
            // Update table
            if (data.events && data.events.length > 0) {
                let tableRows = '';
                data.events.forEach(event => {
                    tableRows += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${event.name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${event.event_type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${event.department}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${event.start_datetime}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                    event.status === 'Concluído' ? 'bg-green-100 text-green-800' :
                                    event.status === 'Em Andamento' ? 'bg-yellow-100 text-yellow-800' :
                                    event.status === 'Planejado' ? 'bg-blue-100 text-blue-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${event.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${event.responsible_person}
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = tableRows;
                
                // Update pagination
                updatePaginationControls(data.current_page, data.total_pages, data.total_events, data.events.length);
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                            Nenhum evento encontrado com os filtros aplicados
                        </td>
                    </tr>
                `;
                
                // Update pagination
                updatePaginationControls(1, 1, 0, 0);
            }
            
            // Update charts
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading report data:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Erro ao carregar dados. Tente novamente.
                    </td>
                </tr>
            `;
            
            // Update pagination with error state
            updatePaginationControls(1, 1, 0, 0);
        });
}

// Update charts with data
function updateCharts(data) {
    /*
    if (data.months && data.event_counts) {
        updateTrendChart(data.months, data.event_counts);
    }
    */
}

// Update trend chart
function updateTrendChart(months, eventCounts) {
    // Create a responsive line chart using CSS and HTML
    let chartHtml = `
        <div class="w-full h-full flex flex-col">
            <div class="flex-1 relative overflow-hidden">
                <svg viewBox="0 0 400 200" preserveAspectRatio="xMidYMid meet" class="w-full h-full">
    `;
    
    // Calculate points for the line chart
    const maxCount = Math.max(...eventCounts);
    const points = [];
    
    months.forEach((month, index) => {
        const x = (index / (months.length - 1)) * 380 + 10;
        const y = 190 - (eventCounts[index] / maxCount) * 180;
        points.push(`${x},${y}`);
    });
    
    // Draw the line
    chartHtml += `
                    <polyline 
                        points="${points.join(' ')}" 
                        fill="none" 
                        stroke="#3b82f6" 
                        stroke-width="2"
                        class="drop-shadow-sm">
                    </polyline>
    `;
    
    // Draw points
    points.forEach((point, index) => {
        const [x, y] = point.split(',');
        chartHtml += `
            <circle cx="${x}" cy="${y}" r="4" fill="#3b82f6" class="hover:r-6 transition-all"></circle>
            <text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#4b5563" class="chart-label">${eventCounts[index]}</text>
        `;
    });
    
    // Draw x-axis labels
    months.forEach((month, index) => {
        const x = (index / (months.length - 1)) * 380 + 10;
        chartHtml += `
            <text x="${x}" y="210" text-anchor="middle" font-size="10" fill="#6b7280" class="chart-label">${month.substring(0, 3)}</text>
        `;
    });
    
    chartHtml += `
                </svg>
            </div>
            <div class="text-center text-sm text-gray-600 mt-2">
                Eventos nos últimos 12 meses
            </div>
        </div>
    `;
    
    document.getElementById('trendChart').innerHTML = chartHtml;
}

// Load trend data
function loadTrendData() {
    fetch('{% url "reports:api_trend" %}')
        .then(response => response.json())
        .then(data => {
            // Create a responsive line chart using CSS and HTML
            let chartHtml = `
                <div class="w-full h-full flex flex-col">
                    <div class="flex-1 relative overflow-hidden">
                        <svg viewBox="0 0 400 200" preserveAspectRatio="xMidYMid meet" class="w-full h-full">
            `;
            
            // Calculate points for the line chart
            const maxCount = Math.max(...data.event_counts);
            const points = [];
            
            data.months.forEach((month, index) => {
                const x = (index / (data.months.length - 1)) * 380 + 10;
                const y = 190 - (data.event_counts[index] / maxCount) * 180;
                points.push(`${x},${y}`);
            });
            
            // Draw the line
            chartHtml += `
                            <polyline 
                                points="${points.join(' ')}" 
                                fill="none" 
                                stroke="#3b82f6" 
                                stroke-width="2"
                                class="drop-shadow-sm">
                            </polyline>
            `;
            
            // Draw points
            points.forEach((point, index) => {
                const [x, y] = point.split(',');
                chartHtml += `
                    <circle cx="${x}" cy="${y}" r="4" fill="#3b82f6" class="hover:r-6 transition-all"></circle>
                    <text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#4b5563" class="chart-label">${data.event_counts[index]}</text>
                `;
            });
            
            // Draw x-axis labels
            data.months.forEach((month, index) => {
                const x = (index / (data.months.length - 1)) * 380 + 10;
                chartHtml += `
                    <text x="${x}" y="210" text-anchor="middle" font-size="10" fill="#6b7280" class="chart-label">${month.substring(0, 3)}</text>
                `;
            });
            
            chartHtml += `
                        </svg>
                    </div>
                    <div class="text-center text-sm text-gray-600 mt-2">
                        Eventos nos últimos 12 meses
                    </div>
                </div>
            `;
            
            document.getElementById('trendChart').innerHTML = chartHtml;
        })
        .catch(error => {
            console.error('Error loading trend data:', error);
            document.getElementById('trendChart').innerHTML = `
                <div class="text-center text-gray-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                    <p>Erro ao carregar tendência</p>
                </div>
            `;
        });
}

// Load locations dynamically for select
function loadLocations() {
    fetch('{% url "reports:api_locations" %}')
        .then(response => response.json())
        .then(data => {
            const selectElement = document.getElementById('locationFilter');
            
            // Clear existing options except the first one
            selectElement.innerHTML = '<option value="">Todas as Localizações</option>';
            
            data.locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                selectElement.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading locations:', error);
        });
}

// Custom Multiselect Functions
function initializeMultiselects() {
    // Function no longer needed with simple selects
}

function toggleMultiselect(multiselectId) {
    // Function no longer needed with simple selects
}

function updateMultiselectSelection(multiselectId) {
    // Function no longer needed with simple selects
}

function getMultiselectValues(multiselectId) {
    // Function no longer needed with simple selects
    return [];
}

function filterMultiselectOptions(multiselectId, searchText) {
    // Function no longer needed with simple selects
}

function resetAllMultiselects() {
    // Function no longer needed with simple selects
}

// Sort table by column
function sortTable(columnIndex) {
    // In a real implementation, this would re-fetch data with sorting parameters
    console.log('Sorting by column:', columnIndex);
}

// Table search functionality
let tableSearchTimeout;
function initializeTableSearch() {
    const searchInput = document.getElementById('tableSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(tableSearchTimeout);
            tableSearchTimeout = setTimeout(() => {
                filterTableRows(this.value);
            }, 300);
        });
    }
    
    // Removed items per page functionality
    /*
    const itemsPerPageSelect = document.getElementById('itemsPerPage');
    if (itemsPerPageSelect) {
        itemsPerPageSelect.addEventListener('change', function() {
            const itemsPerPage = parseInt(this.value);
            updateTablePagination(1, itemsPerPage); // Reset to first page when changing items per page
        });
    }
    */
}

function filterTableRows(searchTerm) {
    const tableBody = document.getElementById('eventsTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        if (cells.length > 1) { // Skip empty state rows
            for (let j = 0; j < cells.length; j++) {
                const cellText = cells[j].textContent.toLowerCase();
                if (cellText.includes(searchTerm.toLowerCase())) {
                    found = true;
                    break;
                }
            }
        }
        
        if (found || searchTerm === '') {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Update pagination info
    updatePaginationInfo(visibleCount);
}

function updateTablePagination(page, itemsPerPage) {
    // Store current pagination state
    window.currentPagination = {
        page: page,
        itemsPerPage: itemsPerPage
    };
    
    // Re-fetch data with pagination parameters
    applyFiltersDebounced();
}

function updatePaginationInfo(visibleCount) {
    document.getElementById('showingFrom').textContent = visibleCount > 0 ? '1' : '0';
    document.getElementById('showingTo').textContent = visibleCount.toString();
    document.getElementById('totalResults').textContent = visibleCount.toString();
}

// Export functionality
function initializeExportButtons() {
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', function() {
            exportReport('pdf');
        });
    }
    
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
            exportReport('excel');
        });
    }
}

function exportReport(format) {
    // Show loading state
    const button = format === 'pdf' ? document.getElementById('exportPdfBtn') : document.getElementById('exportExcelBtn');
    const originalText = button.innerHTML;
    button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Gerando ${format.toUpperCase()}...`;
    button.disabled = true;
    
    // Collect all current filter data
    const formData = new FormData();
    
    // Get filter values
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchFilter').value;
    const responsibleSearch = document.getElementById('responsibleSearchFilter').value;
    const department = document.getElementById('departmentFilter').value;
    const eventType = document.getElementById('eventTypeFilter').value;
    const location = document.getElementById('locationFilter').value;
    
    // Add basic filters
    if (startDate) formData.append('start_date', startDate);
    if (endDate) formData.append('end_date', endDate);
    if (status) formData.append('status', status);
    if (search) formData.append('search', search);
    if (responsibleSearch) formData.append('responsible_search', responsibleSearch);
    if (department) formData.append('departments', department);
    if (eventType) formData.append('event_types', eventType);
    if (location) formData.append('locations', location);
    formData.append('format', format);
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Submit the export request
    fetch('{% url "reports:export" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Erro na resposta do servidor');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `relatorio_${new Date().getTime()}.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        showExportSuccess(format);
    })
    .catch(error => {
        console.error('Export error:', error);
        showExportError(format, error.message);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showExportSuccess(format) {
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    successDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>Relatório ${format.toUpperCase()} gerado com sucesso!</span>
        </div>
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        document.body.removeChild(successDiv);
    }, 3000);
}

function showExportError(format, message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    errorDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>Erro ao gerar ${format.toUpperCase()}: ${message}</span>
        </div>
    `;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        document.body.removeChild(errorDiv);
    }, 5000);
}

// Update pagination controls
function updatePaginationControls(currentPage, totalPages, totalResults, itemsOnPage) {
    // Update pagination info text
    const showingFrom = totalResults > 0 ? ((currentPage - 1) * window.currentPagination.itemsPerPage) + 1 : 0;
    const showingTo = Math.min(currentPage * window.currentPagination.itemsPerPage, totalResults);
    
    document.getElementById('showingFrom').textContent = showingFrom;
    document.getElementById('showingTo').textContent = showingTo;
    document.getElementById('totalResults').textContent = totalResults;
    
    // Update pagination buttons
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    
    // Enable/disable navigation buttons
    if (prevButton) {
        prevButton.disabled = currentPage <= 1;
        prevButton.onclick = () => {
            if (currentPage > 1) {
                updateTablePagination(currentPage - 1, window.currentPagination.itemsPerPage);
            }
        };
    }
    
    if (nextButton) {
        nextButton.disabled = currentPage >= totalPages;
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                updateTablePagination(currentPage + 1, window.currentPagination.itemsPerPage);
            }
        };
    }
    
    // Generate page buttons
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start page if needed
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Clear existing page buttons (except prev/next)
    const paginationContainer = document.querySelector('.pagination-container');
    
    // Remove all page buttons except prev/next
    const pageButtons = paginationContainer.querySelectorAll('button:not(#prevPage):not(#nextPage)');
    pageButtons.forEach(button => button.remove());
    
    // Add new page buttons
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `px-3 py-1.5 text-sm border rounded-lg ${i === currentPage ? 'bg-primary-600 text-white border-primary-600' : 'border-gray-300 hover:bg-gray-50'}`;
        pageButton.textContent = i;
        pageButton.onclick = () => updateTablePagination(i, window.currentPagination.itemsPerPage);
        
        // Insert before next button
        const nextButton = document.getElementById('nextPage');
        if (nextButton) {
            nextButton.parentNode.insertBefore(pageButton, nextButton);
        } else {
            paginationContainer.appendChild(pageButton);
        }
    }
}
</script>

<style>
/* Custom Multiselect Styles */
.custom-multiselect {
    /* Styles no longer needed */
}

.multiselect-trigger {
    /* Styles no longer needed */
}

.multiselect-trigger:hover {
    /* Styles no longer needed */
}

.multiselect-trigger:focus-within {
    /* Styles no longer needed */
}

.multiselect-selected {
    /* Styles no longer needed */
}

.multiselect-selected.selected {
    /* Styles no longer needed */
}

.multiselect-arrow {
    /* Styles no longer needed */
}

.multiselect-dropdown {
    /* Styles no longer needed */
}

.multiselect-search {
    /* Styles no longer needed */
}

.multiselect-search-input {
    /* Styles no longer needed */
}

.multiselect-search-input:focus {
    /* Styles no longer needed */
}

.multiselect-options {
    /* Styles no longer needed */
}

.multiselect-option {
    /* Styles no longer needed */
}

.multiselect-option:hover {
    /* Styles no longer needed */
}

.multiselect-option input[type="checkbox"] {
    /* Styles no longer needed */
}

.multiselect-option input[type="radio"] {
    /* Styles no longer needed */
}

.checkmark {
    /* Styles no longer needed */
}

/* Checkbox styles */
.multiselect-option input[type="checkbox"]:checked ~ .checkmark {
    /* Styles no longer needed */
}

.multiselect-option input[type="checkbox"]:checked ~ .checkmark:after {
    /* Styles no longer needed */
}

/* Radio button styles */
.multiselect-option input[type="radio"] ~ .checkmark {
    /* Styles no longer needed */
}

.multiselect-option input[type="radio"]:checked ~ .checkmark {
    /* Styles no longer needed */
}

.multiselect-option input[type="radio"]:checked ~ .checkmark:after {
    /* Styles no longer needed */
}

.option-text {
    font-size: 14px;
    color: #374151;
    flex: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Loading Indicators */
.loading-indicator {
    display: flex;
    align-items: center;
    padding: 8px 0;
    color: #6b7280;
    font-size: 14px;
}

.success-indicator {
    display: flex;
    align-items: center;
    padding: 8px 0;
    color: #059669;
    font-size: 14px;
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Improved transitions */
.transition-all {
    transition: all 0.2s ease;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .multiselect-dropdown {
        max-height: 200px;
    }
    
    .multiselect-options {
        max-height: 150px;
    }
    
    .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

/* Hide default scrollbar styling */
.multiselect-options::-webkit-scrollbar {
    width: 6px;
}

.multiselect-options::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.multiselect-options::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.multiselect-options::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Chart responsiveness improvements */
.chart-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-label {
    font-family: 'Inter', sans-serif;
    paint-order: stroke;
    stroke: #ffffff;
    stroke-width: 2px;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* Responsive improvements for charts */
@media (max-width: 1024px) {
    .chart-container {
        min-height: 200px;
    }
    
    .chart-label {
        font-size: 8px;
    }
}

@media (max-width: 768px) {
    .chart-container {
        min-height: 180px;
    }
    
    .chart-label {
        font-size: 7px;
    }
}

@media (max-width: 480px) {
    .chart-container {
        min-height: 150px;
    }
    
    .chart-label {
        font-size: 6px;
    }
}

/* Export notification styles */
.notification {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Table search highlight */
.search-highlight {
    background-color: #fef3c7;
    font-weight: 600;
}

/* Pagination loading spinner */
.pagination-spinner {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid rgba(59, 130, 246, 0.2);
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Pagination button states */
button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

/* Responsive pagination */
@media (max-width: 768px) {
    .pagination-container {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .pagination-buttons {
        justify-content: center;
    }
}
</style>
{% endblock %}