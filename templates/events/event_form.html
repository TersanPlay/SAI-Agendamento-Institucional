{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
{% if object %}Editar Evento{% else %}Novo Evento{% endif %} - EventoSys
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200">
        <div class="px-4 sm:px-6 lg:px-8 py-6">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        {% if object %}
                            ‚úèÔ∏è Editar Evento
                        {% else %}
                            ‚ûï Novo Evento
                        {% endif %}
                    </h1>
                    <p class="mt-1 text-sm text-gray-500">
                        {% if object %}
                            Edite as informa√ß√µes do evento "{{ object.name }}"
                        {% else %}
                            Preencha as informa√ß√µes para criar um novo evento
                        {% endif %}
                    </p>
                </div>
                <div class="mt-4 flex md:mt-0 md:ml-4">
                    <a href="{% url 'events:event_list' %}" 
                       class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        ‚Üê Voltar √† Lista
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <form method="post" enctype="multipart/form-data" class="space-y-8">
                {% csrf_token %}
                
                <!-- Main Event Information -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            üìã Informa√ß√µes B√°sicas
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Event Name -->
                            <div class="md:col-span-2">
                                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.name.label }}
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Event Type -->
                            <div>
                                <label for="{{ form.event_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.event_type.label }}
                                </label>
                                {{ form.event_type }}
                                {% if form.event_type.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.event_type.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Status -->
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.status.label }}
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Start DateTime -->
                            <div>
                                <label for="{{ form.start_datetime.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.start_datetime.label }}
                                </label>
                                {{ form.start_datetime }}
                                {% if form.start_datetime.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.start_datetime.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- End DateTime -->
                            <div>
                                <label for="{{ form.end_datetime.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.end_datetime.label }}
                                </label>
                                {{ form.end_datetime }}
                                {% if form.end_datetime.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.end_datetime.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Responsible Person -->
                            <div>
                                <label for="{{ form.responsible_person.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.responsible_person.label }}
                                </label>
                                {{ form.responsible_person }}
                                {% if form.responsible_person.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.responsible_person.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Department -->
                            <div>
                                <label for="{{ form.department.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.department.label }}
                                </label>
                                {{ form.department }}
                                {% if form.department.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.department.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location and Modality -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            üìç Localiza√ß√£o e Modalidade
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Location Mode -->
                            <div>
                                <label for="{{ form.location_mode.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.location_mode.label }}
                                </label>
                                {{ form.location_mode }}
                                {% if form.location_mode.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.location_mode.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Target Audience -->
                            <div>
                                <label for="{{ form.target_audience.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.target_audience.label }}
                                </label>
                                {{ form.target_audience }}
                                {% if form.target_audience.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.target_audience.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Physical Location -->
                            <div>
                                <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.location.label }}
                                </label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.location.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Virtual Link -->
                            <div>
                                <label for="{{ form.virtual_link.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.virtual_link.label }}
                                </label>
                                {{ form.virtual_link }}
                                {% if form.virtual_link.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.virtual_link.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description and Details -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            üìù Descri√ß√£o e Detalhes
                        </h3>
                        <div class="space-y-6">
                            <!-- Description -->
                            <div>
                                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Observations -->
                            <div>
                                <label for="{{ form.observations.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.observations.label }}
                                </label>
                                {{ form.observations }}
                                {% if form.observations.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.observations.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Is Public -->
                            <div class="flex items-center">
                                {{ form.is_public }}
                                <label for="{{ form.is_public.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                                    {{ form.is_public.label }}
                                </label>
                                {% if form.is_public.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.is_public.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            üìé Documentos (Opcional)
                        </h3>
                        {{ document_formset.management_form }}
                        <div id="document-formset">
                            {% for form in document_formset %}
                                <div class="document-form border border-gray-200 rounded-lg p-4 mb-4">
                                    {{ form.id }}
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                T√≠tulo do Documento
                                            </label>
                                            {{ form.title }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Link Externo
                                            </label>
                                            {{ form.external_link }}
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Arquivo
                                            </label>
                                            {{ form.uploaded_file }}
                                        </div>
                                        {% if form.DELETE %}
                                            <div class="md:col-span-2">
                                                {{ form.DELETE }}
                                                <label for="{{ form.DELETE.id_for_label }}" class="ml-2 text-sm text-red-600">
                                                    Remover documento
                                                </label>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Participants -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            üë• Participantes (Opcional)
                        </h3>
                        {{ participant_formset.management_form }}
                        <div id="participant-formset">
                            {% for form in participant_formset %}
                                <div class="participant-form border border-gray-200 rounded-lg p-4 mb-4">
                                    {{ form.id }}
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Usu√°rio do Sistema
                                            </label>
                                            {{ form.user }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Nome (Externo)
                                            </label>
                                            {{ form.name }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Email
                                            </label>
                                            {{ form.email }}
                                        </div>
                                        {% if form.DELETE %}
                                            <div class="md:col-span-3">
                                                {{ form.DELETE }}
                                                <label for="{{ form.DELETE.id_for_label }}" class="ml-2 text-sm text-red-600">
                                                    Remover participante
                                                </label>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Form Errors -->
                {% if form.non_field_errors %}
                    <div class="bg-red-50 border border-red-200 rounded-md p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">
                                    Erros no formul√°rio
                                </h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Submit Buttons -->
                <div class="flex justify-end space-x-3 pt-5">
                    <a href="{% url 'events:event_list' %}" 
                       class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        {% if object %}
                            üíæ Atualizar Evento
                        {% else %}
                            ‚úÖ Criar Evento
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dynamic formset management would go here
    // For now, we'll use the basic inline formsets
    
    // Form validation feedback
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '‚è≥ Processando...';
            }
        });
    }
});
</script>
{% endblock %}